<!DOCTYPE html>
<html>
<head>
  <title>Multiplayer Racing - Lobby</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <link href="common.css" rel="stylesheet" type="text/css" />
  <link href="styles-mp.css" rel="stylesheet" type="text/css" />
</head>
<body>
  <div class="lobby-container">
    <h1>üèéÔ∏è Multiplayer Racing</h1>
    <div class="lobby-form">
      <div class="form-group">
        <label for="roomId">Room ID:</label>
        <input type="text" id="roomId" placeholder="Enter or create room ID" />
        <button id="createRoom" class="btn-secondary">Create New Room</button>
      </div>
      <div class="form-group">
        <label for="playerName">Your Name:</label>
        <input type="text" id="playerName" placeholder="Enter your name" maxlength="20" />
      </div>
      <button id="joinRoom" class="btn-primary">Join Room</button>
      <div id="error" class="error-message"></div>
      <div id="loading" class="loading" style="display: none;">Connecting...</div>
    </div>
    <div class="lobby-info">
      <p>Enter a room ID to join an existing race, or create a new room.</p>
      <p><a href="admin.html">Admin Dashboard</a></p>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  
  <script>
    // Firebase config for hcmracing project
    window.FIREBASE_CONFIG = {
      apiKey: "AIzaSyCUCSUoJRU0pH8iyOA1u8YWvD0DCS1NnXY",
      authDomain: "hcmracing-2e926.firebaseapp.com",
      databaseURL: "https://hcmracing-2e926-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "hcmracing-2e926",
      storageBucket: "hcmracing-2e926.firebasestorage.app",
      messagingSenderId: "1044481928732",
      appId: "1:1044481928732:web:1e41550f339eb3855639d9"
    };
  </script>

  <script type="module">
    import { getAuth, getDatabase, ref, set, get, signInAnonymously, onAuthStateChanged, initFirebase } from './firebase.js';

    let currentUser = null;
    let auth, db;

    // Wait for Firebase to load
    function waitForFirebase() {
      return new Promise((resolve) => {
        if (typeof firebase !== 'undefined') {
          if (initFirebase()) {
            auth = getAuth();
            db = getDatabase();
            resolve();
          } else {
            setTimeout(() => waitForFirebase().then(resolve), 100);
          }
        } else {
          setTimeout(() => waitForFirebase().then(resolve), 100);
        }
      });
    }

    // Initialize Firebase and auth
    waitForFirebase().then(() => {
      onAuthStateChanged((user) => {
        if (user) {
          currentUser = user;
        }
      });
    });

    // Generate random room ID
    function generateRoomId() {
      return Math.random().toString(36).substring(2, 8).toUpperCase();
    }

    // Create room button - t·ª± ƒë·ªông t·∫°o room v√† chuy·ªÉn ƒë·∫øn admin
    document.getElementById('createRoom').addEventListener('click', async () => {
      const roomId = generateRoomId();
      document.getElementById('roomId').value = roomId;
      
      // T·ª± ƒë·ªông join v√† chuy·ªÉn ƒë·∫øn admin
      const playerName = document.getElementById('playerName').value.trim() || 'Admin';
      if (!playerName) {
        document.getElementById('playerName').value = 'Admin';
      }
      
      // ƒê·ª£i Firebase s·∫µn s√†ng
      await waitForFirebase();
      
      try {
        // Sign in anonymously
        if (!currentUser) {
          await signInAnonymously();
          await new Promise((resolve) => {
            const unsubscribe = onAuthStateChanged((user) => {
              if (user) {
                currentUser = user;
                unsubscribe();
                resolve();
              }
            });
          });
        }

        // T·∫°o room v·ªõi admin
        const roomRef = ref(`rooms/${roomId}`);
        await set(roomRef, {
          status: 'waiting',
          createdAt: Date.now(),
          adminId: currentUser.uid,
          startTime: null,
          players: {},
          quiz: {
            active: false,
            question: '',
            options: [],
            correctIndex: -1,
            startTime: null
          },
          answers: {}
        });

        // Add admin as player
        const playerRef = ref(`rooms/${roomId}/players/${currentUser.uid}`);
        await set(playerRef, {
          name: playerName || 'Admin',
          position: 0,
          speed: 0,
          nitro: false,
          finished: false
        });

        // Redirect to admin dashboard
        window.location.href = `admin.html?roomId=${roomId}&uid=${currentUser.uid}`;
      } catch (error) {
        console.error('Error creating room:', error);
        document.getElementById('error').textContent = 'Failed to create room: ' + error.message;
      }
    });

    // Join room button
    document.getElementById('joinRoom').addEventListener('click', async () => {
      const roomId = document.getElementById('roomId').value.trim();
      const playerName = document.getElementById('playerName').value.trim();
      const errorDiv = document.getElementById('error');
      const loadingDiv = document.getElementById('loading');

      errorDiv.textContent = '';
      
      if (!roomId) {
        errorDiv.textContent = 'Vui l√≤ng nh·∫≠p Room ID';
        return;
      }

      if (!playerName) {
        errorDiv.textContent = 'Vui l√≤ng nh·∫≠p t√™n c·ªßa b·∫°n';
        return;
      }

      loadingDiv.style.display = 'block';

      try {
        // ƒê·ª£i Firebase s·∫µn s√†ng
        await waitForFirebase();

        // Sign in anonymously if not already signed in
        if (!currentUser) {
          await signInAnonymously();
          // Wait for auth state to update
          await new Promise((resolve) => {
            const unsubscribe = onAuthStateChanged((user) => {
              if (user) {
                currentUser = user;
                unsubscribe();
                resolve();
              }
            });
          });
        }

        // Check if room exists and get room data
        const roomRef = ref(`rooms/${roomId}`);
        const roomSnapshot = await get(roomRef);
        
        if (!roomSnapshot.exists()) {
          errorDiv.textContent = 'Room kh√¥ng t·ªìn t·∫°i! Vui l√≤ng t·∫°o room m·ªõi.';
          loadingDiv.style.display = 'none';
          return;
        }

        // Get room data to calculate lane (reuse roomSnapshot)
        const roomData = roomSnapshot.val() || {};
        const players = roomData.players || {};
        const playerCount = Object.keys(players).length;
        const totalLanes = Math.max(3, playerCount + 1);
        
        // Assign lane (1 to totalLanes, centered)
        const assignedLane = Math.min(playerCount + 1, totalLanes);
        const laneOffset = ((assignedLane - 1) / (totalLanes - 1)) * 2 - 1; // -1 to 1
        
        // C√°ch 1: Spawn player l·ªách Z m·ªôt ch√∫t ƒë·ªÉ tr√°nh tr√πng
        // L·ªách Z t·ª´ 10-50 ƒë·ªÉ players kh√¥ng spawn c√πng v·ªã tr√≠
        const zOffset = Math.random() * 40 + 10; // 10-50
        
        // Add player to room
        const playerRef = ref(`rooms/${roomId}/players/${currentUser.uid}`);
        await set(playerRef, {
          name: playerName,
          position: zOffset, // L·ªách Z ƒë·ªÉ tr√°nh spawn c√πng v·ªã tr√≠
          speed: 0,
          nitro: false,
          finished: false,
          lane: assignedLane,
          playerX: laneOffset
        });

        // Redirect to game
        window.location.href = `index.html?roomId=${roomId}&uid=${currentUser.uid}`;
      } catch (error) {
        console.error('Error joining room:', error);
        errorDiv.textContent = 'L·ªói khi join room: ' + error.message;
        loadingDiv.style.display = 'none';
      }
    });

    // Allow Enter key to submit
    document.getElementById('roomId').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') document.getElementById('joinRoom').click();
    });
    document.getElementById('playerName').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') document.getElementById('joinRoom').click();
    });
  </script>
</body>
</html>
