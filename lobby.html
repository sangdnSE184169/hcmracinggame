<!DOCTYPE html>
<html>
<head>
  <title>Multiplayer Racing - Lobby</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <link href="common.css" rel="stylesheet" type="text/css" />
  <link href="styles-mp.css" rel="stylesheet" type="text/css" />
</head>
<body>
  <div class="lobby-container">
    <h1>üèéÔ∏è Multiplayer Racing</h1>
    <div class="lobby-form">
      <div class="form-group">
        <label for="roomId">Room ID:</label>
        <input type="text" id="roomId" placeholder="Enter or create room ID" />
        <button id="createRoom" class="btn-secondary">Create New Room</button>
      </div>
      <div class="form-group">
        <label for="playerName">Your Name:</label>
        <input type="text" id="playerName" placeholder="Enter your name" maxlength="20" />
      </div>
      <button id="joinRoom" class="btn-primary">Join Room</button>
      <div id="error" class="error-message"></div>
      <div id="loading" class="loading" style="display: none;">Connecting...</div>
    </div>
    <div class="lobby-info">
      <p>Enter a room ID to join an existing race, or create a new room.</p>
      <p><a href="admin.html">Admin Dashboard</a></p>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  
  <script>
    // Firebase config for hcmracing project
    window.FIREBASE_CONFIG = {
      apiKey: "AIzaSyCUCSUoJRU0pH8iyOA1u8YWvD0DCS1NnXY",
      authDomain: "hcmracing-2e926.firebaseapp.com",
      databaseURL: "https://hcmracing-2e926-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "hcmracing-2e926",
      storageBucket: "hcmracing-2e926.firebasestorage.app",
      messagingSenderId: "1044481928732",
      appId: "1:1044481928732:web:1e41550f339eb3855639d9"
    };
  </script>

  <script type="module">
    import { getAuth, getDatabase, ref, set, get, signInAnonymously, onAuthStateChanged, initFirebase } from './firebase.js';

    // Initialize Firebase
    if (!initFirebase()) {
      console.error('Failed to initialize Firebase');
    }

    const auth = getAuth();
    const db = getDatabase();
    let currentUser = null;

    // Generate random room ID
    function generateRoomId() {
      return Math.random().toString(36).substring(2, 8).toUpperCase();
    }

    // Initialize auth
    onAuthStateChanged(auth, (user) => {
      if (user) {
        currentUser = user;
      }
    });

    // Create room button
    document.getElementById('createRoom').addEventListener('click', () => {
      const roomId = generateRoomId();
      document.getElementById('roomId').value = roomId;
    });

    // Join room button
    document.getElementById('joinRoom').addEventListener('click', async () => {
      const roomId = document.getElementById('roomId').value.trim();
      const playerName = document.getElementById('playerName').value.trim();
      const errorDiv = document.getElementById('error');
      const loadingDiv = document.getElementById('loading');

      errorDiv.textContent = '';
      
      if (!roomId) {
        errorDiv.textContent = 'Please enter a room ID';
        return;
      }

      if (!playerName) {
        errorDiv.textContent = 'Please enter your name';
        return;
      }

      loadingDiv.style.display = 'block';

      try {
        // Sign in anonymously if not already signed in
        if (!currentUser) {
          await signInAnonymously(auth);
          // Wait for auth state to update
          await new Promise((resolve) => {
            const unsubscribe = onAuthStateChanged(auth, (user) => {
              if (user) {
                currentUser = user;
                unsubscribe();
                resolve();
              }
            });
          });
        }

        // Add player to room
        const playerRef = ref(`rooms/${roomId}/players/${currentUser.uid}`);
        await set(playerRef, {
          name: playerName,
          position: 0,
          speed: 0,
          nitro: false,
          finished: false
        });

        // Initialize room if it doesn't exist
        const roomRef = ref(`rooms/${roomId}`);
        const roomSnapshot = await get(roomRef);
        if (!roomSnapshot.exists()) {
          await set(roomRef, {
            status: 'waiting',
            createdAt: Date.now(),
            adminId: currentUser.uid,
            startTime: null,
            players: {},
            quiz: {
              active: false,
              question: '',
              options: [],
              correctIndex: -1,
              startTime: null
            },
            answers: {}
          });
        }

        // Redirect to game
        window.location.href = `index.html?roomId=${roomId}&uid=${currentUser.uid}`;
      } catch (error) {
        console.error('Error joining room:', error);
        errorDiv.textContent = 'Failed to join room: ' + error.message;
        loadingDiv.style.display = 'none';
      }
    });

    // Allow Enter key to submit
    document.getElementById('roomId').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') document.getElementById('joinRoom').click();
    });
    document.getElementById('playerName').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') document.getElementById('joinRoom').click();
    });
  </script>
</body>
</html>
